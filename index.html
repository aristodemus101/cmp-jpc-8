<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CMP 8.0 Tracker - Real-time (GD + PI)</title>

  <!-- React UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const firebaseConfig = {
      apiKey: "AIzaSyA0WITtGofY4WvQb08sZ96RNLE1rM5_Udw",
      authDomain: "iift-mentorship-project.firebaseapp.com",
      projectId: "iift-mentorship-project",
      storageBucket: "iift-mentorship-project.firebasestorage.app",
      messagingSenderId: "185893652365",
      appId: "1:185893652365:web:2e45a3833c1088a39d1fc4",
      measurementId: "G-QQKZG0YEDY"
    };

    // Initialize Firebase (compat)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    const { useState, useEffect, useRef } = React;

    const Icons = {
      Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
      Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
      Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
      Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
      Trash: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
      Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
      Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
      X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
      Paperclip: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
    };

    // --- helper for derived stats from groups (GD & PI use similar structure) ---
    function calculateStatsFromGroups(groups, statusField='status', studentsField='students') {
      const total = groups.length;
      const completed = groups.filter(g => g[statusField] === 'completed').length;
      const inProgress = groups.filter(g => g[statusField] === 'in-progress' || g[statusField] === 'scheduled' || g[statusField] === 'in-progress').length;
      const pending = groups.filter(g => g[statusField] === 'pending' || g[statusField] === 'waiting' || g[statusField] === 'scheduled').length;

      const studentsInCompleted = groups
        .filter(g => g[statusField] === 'completed')
        .reduce((s, g) => s + (g[studentsField]?.length || 0), 0);

      const studentsInInProgress = groups
        .filter(g => g[statusField] === 'in-progress')
        .reduce((s, g) => s + (g[studentsField]?.length || 0), 0);

      const studentsInPending = groups
        .filter(g => g[statusField] === 'pending' || g[statusField] === 'waiting' || g[statusField] === 'scheduled')
        .reduce((s, g) => s + (g[studentsField]?.length || 0), 0);

      const totalStudentsDerived = studentsInCompleted + studentsInInProgress + studentsInPending;

      return {
        total,
        completed,
        inProgress,
        pending,
        studentsInCompleted,
        studentsInInProgress,
        studentsInPending,
        totalStudentsDerived
      };
    }

    // ----------------- Main Component -----------------
    const App = () => {
      // GD state (unchanged)
      const [gdGroups, setGdGroups] = useState([]);
      const [stats, setStats] = useState({
        totalStudents: 0,
        studentsInPI: 0,
        studentsInGD: 0,
        totalMentors: 0,
        totalGDs: 0
      });
      const [tempStats, setTempStats] = useState({ ...stats });
      const [editingStats, setEditingStats] = useState(false);
      const editingStatsRef = useRef(false);

      // UI state
      const [selectedTab, setSelectedTab] = useState('gd'); // 'gd' or 'pi'
      const [loading, setLoading] = useState(true);

      // GD add/edit
      const [newGD, setNewGD] = useState({
        timing: '',
        groupName: '',
        students: [],
        meetLink: '',
        panelists: [],
        spocs: '',
        status: 'pending'
      });
      const [editingGD, setEditingGD] = useState(null);

      // PI state
      const [piList, setPiList] = useState([]);
      const [newPI, setNewPI] = useState({
        studentName: '',
        email: '',
        preference: '',
        domain: '',
        meetLink: '',
        mentorName: '',
        mentorEmail: '',
        slot: '',
        status: 'scheduled' // scheduled, completed, waiting
      });
      const [editingPI, setEditingPI] = useState(null);
      const [piStats, setPiStats] = useState({
        totalPIs: 0,
        completed: 0,
        scheduled: 0,
        waiting: 0,
        totalStudents: 0,
        totalMentors: 0
      });
      const piEditingRef = useRef(false);

      // ---------- GD listeners (preserve your existing behavior) ----------
      useEffect(() => {
        const unsub = db.collection('gdGroups').orderBy('createdAt', 'desc').onSnapshot(snap => {
          const groups = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          setGdGroups(groups);
          // derived update handled earlier in your original code logic (keeps stats doc in sync)
          setLoading(false);
        }, e => {
          console.error('gd snapshot error', e);
          setLoading(false);
        });
        return () => unsub();
      }, []);

      // stats doc for GD (same as before)
      useEffect(() => {
        const unsub = db.collection('stats').doc('dashboard').onSnapshot(doc => {
          if (doc.exists) {
            const d = doc.data();
            setStats({
              totalStudents: d.totalStudents ?? 0,
              studentsInPI: d.studentsInPI ?? 0,
              studentsInGD: d.studentsInGD ?? 0,
              totalMentors: d.totalMentors ?? 0,
              totalGDs: d.totalGDs ?? 0,
              derivedTotalStudents: d.derivedTotalStudents ?? 0
            });
            setTempStats({
              totalStudents: d.totalStudents ?? 0,
              studentsInPI: d.studentsInPI ?? 0,
              studentsInGD: d.studentsInGD ?? 0,
              totalMentors: d.totalMentors ?? 0,
              totalGDs: d.totalGDs ?? 0
            });
          } else {
            db.collection('stats').doc('dashboard').set({
              totalStudents: 0,
              studentsInPI: 0,
              studentsInGD: 0,
              totalMentors: 0,
              totalGDs: 0,
              derivedTotalStudents: 0
            }).catch(e => console.error(e));
          }
        });
        return () => unsub();
      }, []);

      // ---------- PI listeners ----------
      useEffect(() => {
        const unsub = db.collection('pi_tracker').orderBy('slot').onSnapshot(snap => {
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          setPiList(list);

          // calculate derived PI stats
          const derived = (function calcPi(list){
            const total = list.length;
            const completed = list.filter(p => p.status === 'completed').length;
            const scheduled = list.filter(p => p.status === 'scheduled' || p.status === 'in-progress').length;
            const waiting = list.filter(p => p.status === 'waiting' || p.status === 'pending').length;
            const totalStudents = total; // each PI row is one student
            // unique mentors
            const mentors = Array.from(new Set(list.map(p => (p.mentorName || '').trim()).filter(Boolean)));
            const totalMentors = mentors.length;
            return { total, completed, scheduled, waiting, totalStudents, totalMentors };
          })(list);

          // auto-sync derived fields to pi_stats doc if admin not editing
          if (!piEditingRef.current) {
            db.collection('pi_stats').doc('dashboard').get().then(docSnap => {
              const current = docSnap.exists ? docSnap.data() : {};
              const toUpdate = {};
              if (current.totalPIs !== derived.total) toUpdate.totalPIs = derived.total;
              if (current.completed !== derived.completed) toUpdate.completed = derived.completed;
              if (current.scheduled !== derived.scheduled) toUpdate.scheduled = derived.scheduled;
              if (current.waiting !== derived.waiting) toUpdate.waiting = derived.waiting;
              if (current.totalStudents !== derived.totalStudents) toUpdate.totalStudents = derived.totalStudents;
              if (current.totalMentors !== derived.totalMentors) toUpdate.totalMentors = derived.totalMentors;
              if (Object.keys(toUpdate).length > 0) {
                db.collection('pi_stats').doc('dashboard').set(toUpdate, { merge: true }).catch(e => console.error('Error syncing PI derived stats', e));
              }
            }).catch(e => console.error(e));
          }

        }, e => {
          console.error('pi snapshot error', e);
        });
        return () => unsub();
      }, []);

      useEffect(() => {
        const unsub = db.collection('pi_stats').doc('dashboard').onSnapshot(doc => {
          if (doc.exists) {
            const d = doc.data();
            setPiStats({
              totalPIs: d.totalPIs ?? 0,
              completed: d.completed ?? 0,
              scheduled: d.scheduled ?? 0,
              waiting: d.waiting ?? 0,
              totalStudents: d.totalStudents ?? 0,
              totalMentors: d.totalMentors ?? 0
            });
          } else {
            db.collection('pi_stats').doc('dashboard').set({
              totalPIs: 0,
              completed: 0,
              scheduled: 0,
              waiting: 0,
              totalStudents: 0,
              totalMentors: 0
            }).catch(e => console.error(e));
          }
        });
        return () => unsub();
      }, []);

      // ---------------- GD CRUD (same as your code) ----------------
      const addGDStudent = () => {
        setNewGD({...newGD, students: [...newGD.students, { name: '', email: '', attachment: '' }]});
      };
      const updateGDStudent = (i, field, value) => {
        const arr = [...newGD.students]; arr[i][field]=value; setNewGD({...newGD, students:arr});
      };
      const removeGDStudent = (i) => setNewGD({...newGD, students: newGD.students.filter((_,idx)=>idx!==i)});
      const addGDPanelist = () => setNewGD({...newGD, panelists: [...newGD.panelists, {name:'',email:'',phone:''}]});
      const updateGDPanelist = (i, field, value) => { const arr=[...newGD.panelists]; arr[i][field]=value; setNewGD({...newGD, panelists:arr}); };
      const removeGDPanelist = (i) => setNewGD({...newGD, panelists: newGD.panelists.filter((_,idx)=>idx!==i)});

      const handleAddGD = async () => {
        try {
          await db.collection('gdGroups').add({...newGD, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
          setNewGD({ timing:'', groupName:'', students:[], meetLink:'', panelists:[], spocs:'', status:'pending' });
          setSelectedTab('gd');
          alert('GD added');
        } catch(e){ console.error(e); alert('Error adding GD: '+ e.message); }
      };

      const startEditingGD = (gd) => {
        setEditingGD({...gd, students: gd.students ? [...gd.students] : [], panelists: gd.panelists ? [...gd.panelists] : []});
      };
      const cancelEditingGD = () => setEditingGD(null);
      const saveEditingGD = async () => {
        if (!editingGD) return;
        try {
          const { id, ...data } = editingGD;
          await db.collection('gdGroups').doc(id).update(data);
          setEditingGD(null);
          alert('GD saved');
        } catch(e) { console.error(e); alert('Error saving GD: '+ e.message); }
      };

      const handleDeleteGD = async (id) => {
        if (!confirm('Delete this GD?')) return;
        try { await db.collection('gdGroups').doc(id).delete(); alert('deleted'); } catch(e){ console.error(e); alert('Delete error: '+ e.message); }
      };

      // ---------------- PI CRUD ----------------
      const handleAddPI = async () => {
        try {
          // basic validation: studentName or email required
          if (!newPI.studentName && !newPI.email) { alert('Student name or email required'); return; }
          await db.collection('pi_tracker').add({...newPI, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
          setNewPI({ studentName:'', email:'', preference:'', domain:'', meetLink:'', mentorName:'', mentorEmail:'', slot:'', status:'scheduled' });
          setSelectedTab('pi');
          alert('PI added');
        } catch(e){ console.error(e); alert('Error adding PI: '+ e.message); }
      };

      const startEditingPI = (pi) => {
        setEditingPI({...pi}); // single-row PI (one student)
      };
      const cancelEditingPI = () => setEditingPI(null);
      const saveEditingPI = async () => {
        if (!editingPI) return;
        try {
          const { id, ...data } = editingPI;
          await db.collection('pi_tracker').doc(id).update(data);
          setEditingPI(null);
          alert('PI saved');
        } catch(e){ console.error(e); alert('Error saving PI: '+ e.message); }
      };
      const deletePI = async (id) => {
        if (!confirm('Delete this PI row?')) return;
        try { await db.collection('pi_tracker').doc(id).delete(); alert('deleted'); } catch(e){ console.error(e); alert('Delete error: '+ e.message); }
      };

      // PI CSV import (client-side parsing): expects rows similar to your sample
      const handlePIUpload = (file) => {
        if (!file) return;
        Papa.parse(file, {
          complete: (results) => {
            // results.data is 2D array. We'll attempt header detection.
            const rows = results.data.filter(r => r && r.length && r.some(cell => String(cell).trim() !== ''));
            if (rows.length === 0) { alert('No rows found in CSV'); return; }

            // Detect header by checking first row for non-numeric first col or presence of typical header words
            const first = rows[0].map(c => (c||'').toString().toLowerCase());
            const looksLikeHeader = first.some(cell => ['name','email','pref','preference','domain','mentor','slot','meet','link'].some(k => cell.includes(k)));

            const mapped = [];
            for (let i=0;i<rows.length;i++){
              if (i===0 && looksLikeHeader) continue; // skip header
              const row = rows[i];
              // Map by position to your example: 0: index, 1: name, 2: email, 3: pref, 4: domain, 5: meetLink, 6: mentorName, 7: mentorEmail, 8: slot (optional)
              const obj = {
                studentName: (row[1] || '').toString().trim(),
                email: (row[2] || '').toString().trim(),
                preference: (row[3] || '').toString().trim(),
                domain: (row[4] || '').toString().trim(),
                meetLink: (row[5] || '').toString().trim(),
                mentorName: (row[6] || '').toString().trim(),
                mentorEmail: (row[7] || '').toString().trim(),
                slot: (row[8] || '').toString().trim() || (row[0] || '').toString().trim(), // fallback
                status: ((row[9] || '').toString().trim() || 'scheduled')
              };
              // skip empty rows
              if (!obj.studentName && !obj.email) continue;
              mapped.push(obj);
            }

            // Bulk add to Firestore (batch)
            if (mapped.length === 0) { alert('No valid data to import'); return; }
            const batch = db.batch();
            mapped.forEach(m => {
              const ref = db.collection('pi_tracker').doc();
              batch.set(ref, { ...m, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            });
            batch.commit().then(()=> {
              alert('Imported ' + mapped.length + ' PI rows');
            }).catch(e => { console.error(e); alert('Import error: '+ e.message); });
          },
          error: (err) => {
            console.error(err);
            alert('CSV parse error: ' + err.message);
          }
        });
      };

      // PI stats admin editing
      const startEditingPiStats = () => {
        piEditingRef.current = true;
        setPiStats(prev => ({...prev}));
      };
      const handlePiStatsChange = (field, value) => {
        const num = value === '' ? 0 : parseInt(value) || 0;
        setPiStats(prev => ({...prev, [field]: num}));
      };
      const savePiStats = async () => {
        try {
          piEditingRef.current = false;
          await db.collection('pi_stats').doc('dashboard').set({
            totalPIs: piStats.totalPIs,
            completed: piStats.completed,
            scheduled: piStats.scheduled,
            waiting: piStats.waiting,
            totalStudents: piStats.totalStudents,
            totalMentors: piStats.totalMentors
          }, { merge: true });
          alert('PI stats saved');
        } catch(e){ console.error(e); alert('Error saving PI stats: '+ e.message); } finally { piEditingRef.current = false; }
      };
      const cancelPiStatsEdit = () => {
        piEditingRef.current = false;
        // reload from db snapshot (pi_stats listener will repopulate)
      };

      // utility: export PI CSV
      const exportPIcsv = () => {
        const headers = ['Student Name','Email','Preference','Domain','Meet Link','Mentor Name','Mentor Email','Slot','Status'];
        const rows = piList.map(p => [
          p.studentName || '',
          p.email || '',
          p.preference || '',
          p.domain || '',
          p.meetLink || '',
          p.mentorName || '',
          p.mentorEmail || '',
          p.slot || '',
          p.status || ''
        ]);
        const csv = [headers, ...rows].map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'pi_tracker.csv'; a.click();
      };

      // Derived stats for GD (reuse earlier function)
      const derivedGD = calculateStatsFromGroups(gdGroups);

      // Derived stats for PI (from piList)
      const derivedPI = (function(){ 
        const total = piList.length;
        const completed = piList.filter(p=>p.status==='completed').length;
        const scheduled = piList.filter(p=>p.status==='scheduled' || p.status==='in-progress').length;
        const waiting = piList.filter(p=>p.status==='waiting' || p.status==='pending').length;
        const totalStudents = total;
        const mentors = Array.from(new Set(piList.map(p=> (p.mentorName||'').trim()).filter(Boolean)));
        const totalMentors = mentors.length;
        return { total, completed, scheduled, waiting, totalStudents, totalMentors };
      })();

      // ---------------- UI ----------------
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-indigo-50 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-2xl shadow-md p-6 mb-6">
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h1 className="text-3xl font-bold text-indigo-900">CMP 8.0 Tracker</h1>
                  <p className="text-sm text-slate-600">Real-time Sync • Lesgoooo</p>
                </div>

                <div className="flex items-center gap-3">
                  <button onClick={() => {
                    // export both for convenience
                    const exportGd = () => {
                      const headers = ['Timing','Group','Students','Meet Link','Panelists','SPOCs','Status'];
                      const rows = gdGroups.map(g => [
                        g.timing||'',
                        g.groupName||'',
                        (g.students||[]).map(s => `${s.name} (${s.email})`).join('; '),
                        g.meetLink||'',
                        (g.panelists||[]).map(p=> `${p.name} - ${p.phone}`).join('; '),
                        g.spocs||'',
                        g.status||''
                      ]);
                      const csv = [headers, ...rows].map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
                      const blob = new Blob([csv], { type: 'text/csv' });
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a'); a.href=url; a.download='gd_tracker.csv'; a.click();
                    };
                    exportGd();
                  }} className="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700">
                    <Icons.Download /> Export GD CSV
                  </button>
                </div>
              </div>

              {/* Top row: tabs */}
              <div className="flex gap-2 mb-4">
                <button onClick={() => setSelectedTab('gd')} className={`px-4 py-2 rounded-lg ${selectedTab==='gd' ? 'bg-indigo-600 text-white' : 'bg-white border'}`}>GD Tracker</button>
                <button onClick={() => setSelectedTab('pi')} className={`px-4 py-2 rounded-lg ${selectedTab==='pi' ? 'bg-indigo-600 text-white' : 'bg-white border'}`}>PI Tracker</button>
              </div>

              {/* Shared: GD stats (left) and PI stats (right) — keep design consistent */}
              <div className="grid grid-cols-3 gap-4 mb-6">
                {/* GD Students card */}
                <div className="bg-gradient-to-br from-blue-50 to-white p-4 rounded-lg border shadow-sm">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <Icons.Users />
                      <div>
                        <div className="text-xs text-slate-500">Total Students (admin)</div>
                        <div className="text-2xl font-bold text-blue-700">{stats.totalStudents ?? 0}</div>
                      </div>
                    </div>
                  </div>
                  <div className="text-sm text-slate-600 mt-2">
                    <div className="flex justify-between"><div>In PI</div><div className="font-semibold">{stats.studentsInPI ?? 0}</div></div>
                    <div className="flex justify-between"><div>In GD</div><div className="font-semibold">{stats.studentsInGD ?? 0}</div></div>
                    <div className="mt-2 text-xs text-slate-500">Derived GD students: <span className="font-medium">{derivedGD.totalStudentsDerived}</span></div>
                  </div>
                </div>

                {/* Mentors card (editable via existing GD stats edit) */}
                <div className="bg-gradient-to-br from-emerald-50 to-white p-4 rounded-lg border shadow-sm">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <Icons.Users />
                      <div>
                        <div className="text-xs text-slate-500">Total Mentors</div>
                        <div className="text-2xl font-bold text-emerald-700">{stats.totalMentors ?? 0}</div>
                      </div>
                    </div>
                    {!editingStats && <button onClick={() => { editingStatsRef.current = true; startEditingGD; setEditingStats(true); setTempStats({
                      totalStudents: stats.totalStudents ?? 0, studentsInPI: stats.studentsInPI ?? 0, studentsInGD: stats.studentsInGD ?? 0, totalMentors: stats.totalMentors ?? 0, totalGDs: stats.totalGDs ?? gdGroups.length
                    })}} className="text-slate-600 p-1 hover:text-slate-800"><Icons.Edit /></button>}
                  </div>
                  <div className="text-xs text-slate-500">Editable via Stats panel</div>
                </div>

                {/* GDs summary */}
                <div className="bg-gradient-to-br from-amber-50 to-white p-4 rounded-lg border shadow-sm">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <Icons.Calendar />
                      <div>
                        <div className="text-xs text-slate-500">Total GDs</div>
                        <div className="text-2xl font-bold text-amber-700">{derivedGD.total}</div>
                      </div>
                    </div>
                  </div>
                  <div className="text-sm text-slate-600 mt-2">
                    <div className="flex justify-between"><div className="text-green-600 font-semibold">Completed</div><div>{derivedGD.completed}</div></div>
                    <div className="flex justify-between"><div className="text-blue-600 font-semibold">In Progress</div><div>{derivedGD.inProgress}</div></div>
                    <div className="flex justify-between"><div className="text-yellow-600 font-semibold">Waiting</div><div>{derivedGD.pending}</div></div>
                  </div>
                </div>
              </div>

              {/* If editing GD stats show actions */}
              {editingStats && (
                <div className="flex justify-end gap-2 mb-4">
                  <button onClick={() => { editingStatsRef.current=false; setEditingStats(false); setTempStats({...stats}); }} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
                  <button onClick={async () => {
                    try {
                      await db.collection('stats').doc('dashboard').set({
                        totalStudents: tempStats.totalStudents,
                        studentsInPI: tempStats.studentsInPI ?? 0,
                        studentsInGD: tempStats.studentsInGD ?? 0,
                        totalMentors: tempStats.totalMentors ?? 0,
                        totalGDs: tempStats.totalGDs ?? 0
                      }, { merge:true });
                      setEditingStats(false);
                      editingStatsRef.current=false;
                      alert('Stats saved');
                    } catch(e){ console.error(e); alert('Stats save error: '+ e.message); }
                  }} className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save Stats</button>
                </div>
              )}

            </div>

            {/* --- Content area: show tab-specific content --- */}
            {selectedTab === 'gd' ? (
              // ---------------- GD Tracker UI (unchanged) ----------------
              <div className="bg-white rounded-2xl shadow p-6 mb-6">
                <h2 className="text-2xl font-semibold mb-4">GD Groups ({gdGroups.length})</h2>

                {gdGroups.length === 0 ? (
                  <div className="text-center py-12 text-slate-500">
                    <p className="mb-4">No GD groups yet</p>
                    <button onClick={() => setSelectedTab('addGD')} className="bg-indigo-600 text-white px-6 py-2 rounded-lg">Add Your First GD</button>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {gdGroups.map(gd => (
                      <div key={gd.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                        {editingGD && editingGD.id === gd.id ? (
                          <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium mb-1">Timing</label>
                                <input type="text" value={editingGD.timing} onChange={(e)=>setEditingGD({...editingGD,timing:e.target.value})} className="w-full border rounded px-3 py-2" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium mb-1">Group Name</label>
                                <input type="text" value={editingGD.groupName} onChange={(e)=>setEditingGD({...editingGD,groupName:e.target.value})} className="w-full border rounded px-3 py-2" />
                              </div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1">Meet Link</label>
                              <input type="url" value={editingGD.meetLink} onChange={(e)=>setEditingGD({...editingGD,meetLink:e.target.value})} className="w-full border rounded px-3 py-2" />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1">Status</label>
                              <select value={editingGD.status} onChange={(e)=>setEditingGD({...editingGD,status:e.target.value})} className="border rounded px-3 py-2 w-full">
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                              </select>
                            </div>

                            <div className="border-t pt-4">
                              <div className="flex justify-between items-center mb-2">
                                <h4 className="font-semibold text-sm">Students</h4>
                                <button onClick={()=>setEditingGD({...editingGD, students: [...editingGD.students, {name:'',email:'',attachment:''}]})} className="flex items-center gap-1 bg-indigo-600 text-white px-2 py-1 rounded text-xs"><Icons.Plus/> Add</button>
                              </div>
                              {editingGD.students.map((s, idx)=>(
                                <div key={idx} className="grid grid-cols-12 gap-2 mb-2 items-end">
                                  <div className="col-span-4"><input className="w-full border rounded px-2 py-1 text-sm" value={s.name} onChange={(e)=>{ const arr=[...editingGD.students]; arr[idx].name=e.target.value; setEditingGD({...editingGD, students:arr});}} /></div>
                                  <div className="col-span-4"><input className="w-full border rounded px-2 py-1 text-sm" value={s.email} onChange={(e)=>{ const arr=[...editingGD.students]; arr[idx].email=e.target.value; setEditingGD({...editingGD, students:arr});}} /></div>
                                  <div className="col-span-3"><input className="w-full border rounded px-2 py-1 text-sm" value={s.attachment||''} onChange={(e)=>{ const arr=[...editingGD.students]; arr[idx].attachment=e.target.value; setEditingGD({...editingGD, students:arr});}} /></div>
                                  <div className="col-span-1"><button onClick={()=>{ const arr=editingGD.students.filter((_,i)=>i!==idx); setEditingGD({...editingGD, students:arr});}} className="w-full bg-red-100 text-red-600 p-1 rounded"><Icons.X/></button></div>
                                </div>
                              ))}
                            </div>

                            <div className="border-t pt-4">
                              <div className="flex justify-between items-center mb-2">
                                <h4 className="font-semibold text-sm">Panelists</h4>
                                <button onClick={()=>setEditingGD({...editingGD, panelists: [...editingGD.panelists, {name:'',email:'',phone:''}]})} className="flex items-center gap-1 bg-green-600 text-white px-2 py-1 rounded text-xs"><Icons.Plus/> Add</button>
                              </div>
                              {editingGD.panelists.map((p, idx)=>(
                                <div key={idx} className="grid grid-cols-12 gap-2 mb-2 items-end">
                                  <div className="col-span-4"><input className="w-full border rounded px-2 py-1 text-sm" value={p.name} onChange={(e)=>{ const arr=[...editingGD.panelists]; arr[idx].name=e.target.value; setEditingGD({...editingGD, panelists:arr});}} /></div>
                                  <div className="col-span-4"><input className="w-full border rounded px-2 py-1 text-sm" value={p.email} onChange={(e)=>{ const arr=[...editingGD.panelists]; arr[idx].email=e.target.value; setEditingGD({...editingGD, panelists:arr});}} /></div>
                                  <div className="col-span-3"><input className="w-full border rounded px-2 py-1 text-sm" value={p.phone} onChange={(e)=>{ const arr=[...editingGD.panelists]; arr[idx].phone=e.target.value; setEditingGD({...editingGD, panelists:arr});}} /></div>
                                  <div className="col-span-1"><button onClick={()=>{ const arr=editingGD.panelists.filter((_,i)=>i!==idx); setEditingGD({...editingGD, panelists:arr});}} className="w-full bg-red-100 text-red-600 p-1 rounded"><Icons.X/></button></div>
                                </div>
                              ))}
                            </div>

                            <div>
                              <label className="block text-sm font-medium mb-1">SPOCs</label>
                              <input className="w-full border rounded px-3 py-2" value={editingGD.spocs||''} onChange={(e)=>setEditingGD({...editingGD, spocs:e.target.value})}/>
                            </div>

                            <div className="flex justify-end gap-2">
                              <button onClick={cancelEditingGD} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
                              <button onClick={saveEditingGD} className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 flex items-center gap-2"><Icons.Save/> Save Changes</button>
                            </div>
                          </div>
                        ) : (
                          <>
                            <div className="flex justify-between items-start mb-3">
                              <div className="flex-1">
                                <div className="flex items-center gap-4 mb-2">
                                  <span className="text-lg font-bold text-indigo-600">{gd.groupName}</span>
                                  <span className="text-sm text-slate-500">{gd.timing}</span>
                                  <span className={`px-3 py-1 rounded-full text-xs font-semibold ${gd.status==='completed' ? 'bg-green-100 text-green-700 border border-green-300' : gd.status==='in-progress' ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-yellow-100 text-yellow-700 border border-yellow-300'}`}>
                                    {gd.status==='completed' ? '✓ Completed' : gd.status==='in-progress' ? '⟳ In Progress' : '⏳ Waiting'}
                                  </span>
                                  <select value={gd.status} onChange={(e)=>handleUpdateGD(gd.id,'status',e.target.value)} className="text-xs border rounded px-2 py-1 bg-white">
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                  </select>
                                </div>
                                {gd.meetLink && <a href={gd.meetLink} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline text-sm">🔗 Join Meeting with this link</a>}
                              </div>
                              <div className="flex items-center gap-3">
                                <button onClick={()=>startEditingGD(gd)} className="text-indigo-600 hover:text-indigo-800"><Icons.Edit/></button>
                                <button onClick={()=>handleDeleteGD(gd.id)} className="text-red-600 hover:text-red-800"><Icons.Trash/></button>
                              </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <h4 className="font-semibold text-sm mb-2">Students:</h4>
                                {gd.students && gd.students.length>0 ? (
                                  <ul className="text-sm space-y-1">{gd.students.map((s,idx)=>(<li key={idx} className="flex items-center gap-2">• {s.name}{s.attachment && <a href={s.attachment} target="_blank" rel="noopener noreferrer" className="text-indigo-600 ml-2"><Icons.Paperclip/></a>}</li>))}</ul>
                                ) : <p className="text-sm text-slate-500">No students added</p>}
                              </div>
                              <div>
                                <h4 className="font-semibold text-sm mb-2">Panelists:</h4>
                                {gd.panelists && gd.panelists.length>0 ? (<ul className="text-sm space-y-1">{gd.panelists.map((p,idx)=>(<li key={idx}>• {p.name} ({p.phone})</li>))}</ul>) : <p className="text-sm text-slate-500">No panelists added</p>}
                              </div>
                            </div>

                            {gd.spocs && <div className="mt-3 pt-3 border-t"><span className="text-xs text-slate-600">SPOCs: {gd.spocs}</span></div>}
                          </>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ) : (
              // ---------------- PI Tracker UI ----------------
              <div className="space-y-6">
                <div className="bg-white rounded-2xl shadow p-6">
                  <div className="flex items-center justify-between mb-4">
                    <div>
                      <h2 className="text-2xl font-semibold">PI Tracker ({piList.length})</h2>
                      <p className="text-sm text-slate-500">Upload CSV or add rows manually. Slot example: 17:00</p>
                    </div>

                    <div className="flex items-center gap-2">
                      <input id="piCsvInput" type="file" accept=".csv" onChange={(e)=> handlePIUpload(e.target.files[0])} className="block"/>
                      <button onClick={exportPIcsv} className="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">Export CSV</button>
                    </div>
                  </div>

                  {/* PI Stats */}
                  <div className="grid grid-cols-3 gap-4">
                    <div className="bg-gradient-to-br from-indigo-50 to-white p-4 rounded-lg border shadow-sm">
                      <div className="text-xs text-slate-500">Total PIs</div>
                      <div className="text-2xl font-bold text-indigo-700">{piStats.totalPIs ?? derivedPI.total}</div>
                    </div>

                    <div className="bg-gradient-to-br from-emerald-50 to-white p-4 rounded-lg border shadow-sm">
                      <div className="text-xs text-slate-500">Completed</div>
                      <div className="text-2xl font-bold text-emerald-700">{piStats.completed ?? derivedPI.completed}</div>
                    </div>

                    <div className="bg-gradient-to-br from-amber-50 to-white p-4 rounded-lg border shadow-sm">
                      <div className="text-xs text-slate-500">Scheduled / Waiting</div>
                      <div className="text-2xl font-bold text-amber-700">{(piStats.scheduled ?? derivedPI.scheduled) + (piStats.waiting ?? derivedPI.waiting)}</div>
                    </div>
                  </div>

                  {/* Admin edit of PI stats */}
                  <div className="mt-4">
                    {!piEditingRef.current ? (
                      <div className="flex gap-2">
                        <button onClick={()=> { piEditingRef.current=true; /* copy current stats into state */ setPiStats(prev=>({...prev})); }} className="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Edit PI Stats</button>
                      </div>
                    ) : (
                      <div className="flex gap-2 items-center">
                        <input type="number" value={piStats.totalPIs ?? 0} onChange={(e)=>handlePiStatsChange('totalPIs', e.target.value)} className="border rounded px-2 py-1 w-28"/>
                        <input type="number" value={piStats.completed ?? 0} onChange={(e)=>handlePiStatsChange('completed', e.target.value)} className="border rounded px-2 py-1 w-28"/>
                        <input type="number" value={piStats.scheduled ?? 0} onChange={(e)=>handlePiStatsChange('scheduled', e.target.value)} className="border rounded px-2 py-1 w-28"/>
                        <input type="number" value={piStats.waiting ?? 0} onChange={(e)=>handlePiStatsChange('waiting', e.target.value)} className="border rounded px-2 py-1 w-28"/>
                        <button onClick={savePiStats} className="px-3 py-2 bg-green-600 text-white rounded">Save</button>
                        <button onClick={()=>{ piEditingRef.current=false; }} className="px-3 py-2 bg-gray-200 rounded">Cancel</button>
                      </div>
                    )}
                  </div>
                </div>

                {/* PI list (editable) */}
                <div className="bg-white rounded-2xl shadow p-6">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-semibold">PI Rows</h3>
                    <div className="flex gap-2">
                      <button onClick={()=> setSelectedTab('pi_add')} className="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Add PI</button>
                    </div>
                  </div>

                  {piList.length === 0 ? (
                    <div className="text-center py-12 text-slate-500">No PI rows. Upload CSV or add manually.</div>
                  ) : (
                    <div className="space-y-4">
                      {piList.map(pi => (
                        <div key={pi.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                          {editingPI && editingPI.id === pi.id ? (
                            <div className="space-y-3">
                              <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs">Student Name</label><input className="w-full border rounded px-2 py-1" value={editingPI.studentName||''} onChange={(e)=>setEditingPI({...editingPI, studentName:e.target.value})}/></div>
                                <div><label className="text-xs">Email</label><input className="w-full border rounded px-2 py-1" value={editingPI.email||''} onChange={(e)=>setEditingPI({...editingPI, email:e.target.value})}/></div>
                              </div>
                              <div className="grid grid-cols-3 gap-4">
                                <div><label className="text-xs">Preference</label><input className="w-full border rounded px-2 py-1" value={editingPI.preference||''} onChange={(e)=>setEditingPI({...editingPI, preference:e.target.value})}/></div>
                                <div><label className="text-xs">Domain</label><input className="w-full border rounded px-2 py-1" value={editingPI.domain||''} onChange={(e)=>setEditingPI({...editingPI, domain:e.target.value})}/></div>
                                <div><label className="text-xs">Slot</label><input className="w-full border rounded px-2 py-1" value={editingPI.slot||''} onChange={(e)=>setEditingPI({...editingPI, slot:e.target.value})}/></div>
                              </div>
                              <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs">Meet Link</label><input className="w-full border rounded px-2 py-1" value={editingPI.meetLink||''} onChange={(e)=>setEditingPI({...editingPI, meetLink:e.target.value})}/></div>
                                <div><label className="text-xs">Status</label>
                                  <select className="w-full border rounded px-2 py-1" value={editingPI.status||'scheduled'} onChange={(e)=>setEditingPI({...editingPI, status:e.target.value})}>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="completed">Completed</option>
                                    <option value="waiting">Waiting</option>
                                  </select>
                                </div>
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs">Mentor Name</label><input className="w-full border rounded px-2 py-1" value={editingPI.mentorName||''} onChange={(e)=>setEditingPI({...editingPI, mentorName:e.target.value})}/></div>
                                <div><label className="text-xs">Mentor Email</label><input className="w-full border rounded px-2 py-1" value={editingPI.mentorEmail||''} onChange={(e)=>setEditingPI({...editingPI, mentorEmail:e.target.value})}/></div>
                              </div>

                              <div className="flex justify-end gap-2">
                                <button onClick={cancelEditingPI} className="px-3 py-2 bg-gray-200 rounded">Cancel</button>
                                <button onClick={saveEditingPI} className="px-3 py-2 bg-indigo-600 text-white rounded">Save</button>
                              </div>
                            </div>
                          ) : (
                            <div className="flex justify-between items-start">
                              <div>
                                <div className="flex items-center gap-3 mb-2">
                                  <div className="text-sm font-semibold">{pi.studentName || pi.email}</div>
                                  <div className="text-xs text-slate-500">{pi.preference} • {pi.domain}</div>
                                  <div className={`px-2 py-1 text-xs rounded-full ${pi.status==='completed' ? 'bg-emerald-100 text-emerald-700' : pi.status==='scheduled' ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700'}`}>{pi.status}</div>
                                </div>
                                <div className="text-sm text-slate-600">
                                  <div>{pi.email}</div>
                                  {pi.meetLink && <a href={pi.meetLink} className="text-indigo-600 hover:underline" target="_blank" rel="noreferrer">🔗 Meet</a>}
                                </div>
                                <div className="mt-2 text-xs text-slate-500">Mentor: {pi.mentorName || '—'} {pi.mentorEmail ? `(${pi.mentorEmail})` : ''} • Slot: {pi.slot || '—'}</div>
                              </div>

                              <div className="flex gap-2">
                                <button onClick={()=>startEditingPI(pi)} className="text-indigo-600 hover:text-indigo-800"><Icons.Edit/></button>
                                <button onClick={()=>deletePI(pi.id)} className="text-red-600 hover:text-red-800"><Icons.Trash/></button>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* PI Add view (re-uses same style as GD add) */}
                <div className="bg-white rounded-2xl shadow p-6">
                  <h3 className="text-lg font-semibold mb-4">Add / Import PI</h3>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-xs">Student Name</label>
                      <input className="w-full border rounded px-2 py-1" value={newPI.studentName} onChange={(e)=>setNewPI({...newPI, studentName:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-xs">Email</label>
                      <input className="w-full border rounded px-2 py-1" value={newPI.email} onChange={(e)=>setNewPI({...newPI, email:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-xs">Preference</label>
                      <input className="w-full border rounded px-2 py-1" value={newPI.preference} onChange={(e)=>setNewPI({...newPI, preference:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-xs">Domain</label>
                      <input className="w-full border rounded px-2 py-1" value={newPI.domain} onChange={(e)=>setNewPI({...newPI, domain:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-xs">Meet Link</label>
                      <input className="w-full border rounded px-2 py-1" value={newPI.meetLink} onChange={(e)=>setNewPI({...newPI, meetLink:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-xs">Slot</label>
                      <input className="w-full border rounded px-2 py-1" value={newPI.slot} onChange={(e)=>setNewPI({...newPI, slot:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-xs">Mentor Name</label>
                      <input className="w-full border rounded px-2 py-1" value={newPI.mentorName} onChange={(e)=>setNewPI({...newPI, mentorName:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-xs">Mentor Email</label>
                      <input className="w-full border rounded px-2 py-1" value={newPI.mentorEmail} onChange={(e)=>setNewPI({...newPI, mentorEmail:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-xs">Status</label>
                      <select className="w-full border rounded px-2 py-1" value={newPI.status} onChange={(e)=>setNewPI({...newPI, status:e.target.value})}>
                        <option value="scheduled">Scheduled</option>
                        <option value="completed">Completed</option>
                        <option value="waiting">Waiting</option>
                      </select>
                    </div>
                  </div>

                  <div className="flex justify-end gap-2 mt-4">
                    <button onClick={()=> setNewPI({ studentName:'', email:'', preference:'', domain:'', meetLink:'', mentorName:'', mentorEmail:'', slot:'', status:'scheduled' })} className="px-4 py-2 bg-gray-200 rounded">Reset</button>
                    <button onClick={handleAddPI} className="px-4 py-2 bg-indigo-600 text-white rounded">Save PI</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
